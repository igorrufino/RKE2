# CronJob para auto-unseal do Vault
apiVersion: batch/v1
kind: CronJob
metadata:
  name: vault-unsealer
  namespace: vault
spec:
  # Executa a cada minuto
  schedule: "*/1 * * * *"
  
  # Manter apenas os Ãºltimos 3 jobs
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: vault-unsealer
        spec:
          restartPolicy: OnFailure
          
          containers:
          - name: vault-unsealer
            image: hashicorp/vault:1.15.2
            
            command:
            - /bin/sh
            - -c
            - |
              echo "ğŸ” Verificando status do Vault..."
              
              # Aguardar Vault estar disponÃ­vel
              while ! vault status >/dev/null 2>&1; do
                echo "â³ Aguardando Vault estar disponÃ­vel..."
                sleep 10
              done
              
              # Verificar se estÃ¡ selado
              if vault status | grep -q "Sealed.*true"; then
                echo "ğŸ”’ Vault estÃ¡ selado - iniciando unseal..."
                
                # Fazer unseal com as 3 chaves
                vault operator unseal $UNSEAL_KEY_1
                echo "ğŸ”‘ Chave 1 aplicada"
                
                vault operator unseal $UNSEAL_KEY_2  
                echo "ğŸ”‘ Chave 2 aplicada"
                
                vault operator unseal $UNSEAL_KEY_3
                echo "ğŸ”‘ Chave 3 aplicada"
                
                echo "âœ… Vault desbloqueado com sucesso!"
              else
                echo "âœ… Vault jÃ¡ estÃ¡ desbloqueado"
              fi
            
            env:
            - name: VAULT_ADDR
              value: "http://vault.vault.svc.cluster.local:8200"
            
            - name: UNSEAL_KEY_1
              valueFrom:
                secretKeyRef:
                  name: vault-unseal-keys
                  key: key1
            
            - name: UNSEAL_KEY_2
              valueFrom:
                secretKeyRef:
                  name: vault-unseal-keys
                  key: key2
            
            - name: UNSEAL_KEY_3
              valueFrom:
                secretKeyRef:
                  name: vault-unseal-keys
                  key: key3
